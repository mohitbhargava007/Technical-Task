/*Create an Empty Table */
DROP TABLE dbo.CUSTOMER_DATA_MODEL;
CREATE TABLE dbo.CUSTOMER_DATA_MODEL
(
CUSTOMER_ID BIGINT ,
PRODUCT_ID BIGINT ,
PRODUCT_NR VARCHAR (100) ,
PRODUCT_OPEN_DT DATE NOT NULL,
PRODUCT_CLOSE_DT DATE ,
PRIMARY_HOLDER INTEGER ,
JOINT_ACCOUNT INTEGER ,
BALANCE	Decimal(18,2)
)
;

/*Insert data in the Table */
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (12345678,11223344,'Current','2002/01/01','',0,1,1547.22);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (12345678,22334455,'Saving','1992/01/01','1992/12/31',1,0,0);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (12345678,22334455,'Saving','1993/01/01','1993/12/31',1,0,0);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (12345678,77889911,'Saving','2012/01/01','',1,0,5674.23);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (12345678,33445566,'Mortgage','2002/05/01','',1,1,-180695.47);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (23456789,33445566,'Mortgage','2002/05/01','',1,1,-180695.47);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (12345678,44556677,'Insurance','2021/05/01','',1,0,146.00);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (12345678,55667788,'Current','1992/01/01','',1,0,83.58);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (23456789,11223344,'Current','2002/01/01','',1,1,1547.22);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (23456789,11223344,'Saving','2013/06/01','',1,1,558.18);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (345678901,66778899,'Saving','2011/02/11','',1,0,6510.85);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (456789012,66778899,'Saving','1956/11/21','1957/11/20',1,0,0.00);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (567890123,66778899,'Current','2005/05/01','2010/10/25',1,0,0.00);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (678901234,66778899,'Current','1984/01/11','2019/10/14',1,0,0.00);
INSERT INTO dbo.CUSTOMER_DATA_MODEL VALUES (789012345,88991112,'Current','2015/09/08','',1,0,-7.99);


/*Select from the table to check data */
SELECT * FROM dbo.CUSTOMER_DATA_MODEL Order by CUSTOMER_ID;

/*Aggregate views from the table showing total balance by customer where customer have multiple accounts*/
SELECT CUSTOMER_ID
,COUNT(PRODUCT_ID) NO_OF_ACCOUNTS
,SUM(BALANCE) TOTAL_BAL
INTO AGG_VIEW_BY_CUSTOMER	--Temp Table
FROM dbo.CUSTOMER_DATA_MODEL 
WHERE PRODUCT_NR <> 'Mortgage' 
AND PRODUCT_CLOSE_DT = '1900-01-01' 
GROUP BY CUSTOMER_ID;

SELECT * FROM AGG_VIEW_BY_CUSTOMER WHERE NO_OF_ACCOUNTS > 1;

/*Showing customers who do not have accounts i.e. Closed accounts with xyz Bank*/
SELECT CUSTOMER_ID,PRODUCT_NR FROM dbo.CUSTOMER_DATA_MODEL WHERE PRODUCT_CLOSE_DT = '1900-01-01' ;